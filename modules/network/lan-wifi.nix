# [[file:../../new_project.org::*LAN WiFi][LAN WiFi:1]]
{ config, lib, infra, ... }:
let
  infraMetadata = lib.importTOML (infra + "/infra.toml");
  inherit (infraMetadata.network) lan;
  local_address = lan.first_octets + "." + lan."${config.networking.hostName}".ip;
in
{
  networking = {
    # Disable autogenerated names
    usePredictableInterfaceNames = false;
    # Systemd-networkd enabled
    useNetworkd = true;
    defaultGateway.interface = "wifi-lan";
  };

  systemd.network.networks = {
    "10-wifi-lan" = {
      enable = true;
      name = "wifi-lan";
      dns = lan.dns_servers;
      # Search domain goes here
      domains = [ lan.domain ];
      networkConfig = {
        Address = [ "${local_address}/24" ];
        Gateway = lan.defaultGateway;
        DHCP = "no";
        DNSSEC = "yes";
        DNSOverTLS = "no";
        # Disable ipv6 explicitly
        LinkLocalAddressing = "no";
      };
    };
  };
  # I am not using llmnr in my LAN
  services.resolved.llmnr = "false";

  # Any interface being up should be OK
  systemd.network.wait-online.anyInterface = true;
}
# LAN WiFi:1 ends here
